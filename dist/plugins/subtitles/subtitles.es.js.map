{"version":3,"file":"subtitles.es.js","sources":["../../../source/Plugin/Subtitles/SubtitleSettingMenuItem.js","../../../source/Plugin/Subtitles/Subtitles.js"],"sourcesContent":["import videojs from 'video.js';\n\nconst SettingOptionItem = videojs.getComponent('SettingOptionItem');\n\nclass SubtitleSettingMenuItem extends SettingOptionItem {\n  constructor(player, options) {\n    super(player, {\n      ...options,\n      name: 'SubtitleSettingMenuItem',\n      label: 'Subtitles',\n      icon: 'vjs-icon-subtitles',\n      entries: player.options_.subtitles || []\n    });\n\n    this.addClass('vjs-setting-subtitles');\n\n    player.on('subtitles', (_, subtitles) => {\n      this.setEntries([\n        ...subtitles.map((val, index) => ({\n          ...val,\n          value: index\n        })),\n        {\n          label: 'Close Subtitles',\n          value: -1,\n          default: false\n        }\n      ]);\n\n      this.show();\n    });\n\n    player.on('subtitlechange', (_, { index }) => {\n      if (index === -1) {\n        // close subtitles\n        index = this.entries.length - 1;\n      }\n\n      this.select(index);\n      this.update(index);\n    });\n  }\n\n  onChange({ value }) {\n    this.player_.subtitles().pick(value);\n  }\n}\n\nvideojs.getComponent('SettingMenuButton').prototype.options_.entries.push('SubtitleSettingMenuItem');\n\nvideojs.registerComponent('SubtitleSettingMenuItem', SubtitleSettingMenuItem);\n\nexport default SubtitleSettingMenuItem;\n","import videojs from 'video.js';\n\nimport './SubtitleSettingMenuItem';\nimport './Subtitles.scss';\n\nclass subtitles extends videojs.getPlugin('plugin') {\n  constructor(player, options) {\n    super(player, options);\n\n    this.flag = null;\n    this.track = null;\n\n    let timeout;\n    const handleSubtitleChangeEvent = () => {\n      clearTimeout(timeout);\n\n      const subtitles = this.values();\n      const currentSubtitle = subtitles.find(t => t.mode === 'showing') || {};\n      const newFlag = currentSubtitle.label || currentSubtitle.id || -1;\n\n      // multiple `change` event will reveiced when subtitles changed ( depends on number of subtitles or browser ? )\n      // so that timeout is used to make sure `subtitlechange` event emit once;\n      timeout = setTimeout(() => {\n        if (this.flag !== newFlag) {\n          this.flag = newFlag;\n\n          player.trigger('subtitlechange', {\n            index: subtitles.indexOf(currentSubtitle),\n            label: currentSubtitle.label || ''\n          });\n        }\n      }, 10);\n    };\n\n    player.textTracks().on('change', handleSubtitleChangeEvent);\n    player.on('dispose', () => {\n      player.textTracks().off('change', handleSubtitleChangeEvent);\n    });\n  }\n\n  values() {\n    const tracks = this.player.textTracks();\n    const subtitles = [];\n\n    for (let i = 0; i < tracks.length; i++) {\n      if (tracks[i].kind === 'subtitles') {\n        subtitles.push(tracks[i]);\n      }\n    }\n\n    return subtitles;\n  }\n\n  load(subtitles_ = []) {\n    const { player } = this;\n\n    const subtitles = subtitles_.map(a => Object.assign({}, a));\n\n    if (subtitles && subtitles.length) {\n      this.remove();\n\n      subtitles.forEach(subtitle => {\n        if (this.flag) {\n          subtitle.default = this.flag === subtitle.label || -1;\n        }\n\n        const manualCleanup = true;\n\n        // set default to false, otherwise subtitle will reset to the default subtitle\n        // when user switch quality with quality plugin\n        const trackEl = player.addRemoteTextTrack(\n          {\n            ...subtitle,\n            default: false\n          },\n          manualCleanup\n        );\n\n        if (subtitle.default) {\n          this.flag = subtitle.label;\n          this.track = trackEl.track;\n\n          trackEl.track.mode = 'showing';\n        }\n      });\n\n      player.trigger('subtitles', subtitles);\n    }\n\n    return this;\n  }\n\n  remove() {\n    this.values().forEach(track => {\n      this.player.removeRemoteTextTrack(track);\n    });\n\n    return this;\n  }\n\n  pick(index) {\n    const subtitles = this.values();\n    const newTrack = subtitles[index];\n\n    if (newTrack) {\n      this.track.mode = 'disabled';\n      this.track = newTrack;\n\n      newTrack.mode = 'showing';\n    } else {\n      this.track.mode = 'disabled';\n    }\n\n    return this;\n  }\n}\n\nvideojs.hook('setup', vjsPlayer => {\n  vjsPlayer.ready(() => {\n    vjsPlayer.subtitles().load(vjsPlayer.options_.subtitles);\n  });\n});\n\nvideojs.registerPlugin('subtitles', subtitles);\n"],"names":["SettingOptionItem","videojs","getComponent","SubtitleSettingMenuItem","player","options","name","label","icon","entries","options_","subtitles","addClass","on","_","setEntries","map","val","index","value","show","length","select","update","onChange","player_","pick","prototype","push","registerComponent","flag","track","timeout","handleSubtitleChangeEvent","clearTimeout","values","currentSubtitle","find","t","mode","newFlag","id","setTimeout","trigger","indexOf","textTracks","off","tracks","i","kind","load","subtitles_","a","Object","assign","remove","forEach","subtitle","manualCleanup","trackEl","addRemoteTextTrack","removeRemoteTextTrack","newTrack","getPlugin","hook","vjsPlayer","ready","registerPlugin"],"mappings":"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"}